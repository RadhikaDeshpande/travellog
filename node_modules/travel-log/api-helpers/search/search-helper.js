//////////////////////////////////////////////////////////////////////////
//                  Global Search API helper
// Here we handle all requests related to the search from user app  
// Usage: 
// var searchApiHelper       = require(DEFS.DIR.API_HELPER_SEARCH);
// var searchApiHelperObj    = new searchApiHelper();
//////////////////////////////////////////////////////////////////////////

// Connect to the database
var dbConnect = require(DEFS.DIR.DB_CONNECT)('openshift');
var sp        = require(DEFS.DIR.DB_SP);

var scubits = function() {
  
  // format for call back: callback(returnMsg, returnData);
  // return all the malls, brands and shops matching the search string 
  this.searchBrandsShopsMalls = function(req, res, searchArray, callback) {

    var returnData = {};
    var returnMsg;

    //Get the USP 
    var searchAll = new sp('usp_search_all_mall_shop_brand');
    searchAll.add(searchArray.locId, false);
    searchAll.add(searchArray.searchString,true);

    dbConnect.query(searchAll.call(), function(err, rows) {
      if(err || !rows) {
        SCUBE_LOG.info('DB Error : ' + err + 'while searching for string ' 
        				+ 'for search string' + searchArray.searchString
                +' for location id ' + searchArray.locId);
        returnMsg = 'failure'
        callback(returnMsg, null);
        return;
      }
      
      // For Output format refer : 
      // https://sparkking.wikispaces.com/API+-+Global+Search
      // Build jsonData for scubits 
      var jsonReqArray = {};
      jsonReqArray.reqtype = DEFS.CONST.JSON_TYPE['multiArrayMultipleObj'];
      jsonReqArray.reqData = rows;

      jsonReqArray.arrayName = ['malls','shops','brands']; 
      jsonReqArray.arrayLength = 3;
 
      jBuilder.buildDBDataJSON(jsonReqArray, function(jsonData) {
          // Send back the restructured data
        SCUBE_LOG.info('usp : usp_search_all_mall_shop_brand success');
        SCUBE_LOG.info(jsonData);
        returnMsg = 'success';
        callback(returnMsg, jsonData);
        return;
      });
    });
  }
}
module.exports = scubits;

