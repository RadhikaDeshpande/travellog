//////////////////////////////////////////////////////////////////////////
//                  User Profile Get API helpers
// Here we handle all requests related to the users API END POINT 
// Usage: 
// var userfavoritesGetHelper     = require(DEFS.DIR.API_HELPER_USER_FAVORITES_GET);
// var userfavoritesGetHelperObj  = new userfavoritesGetHelper();
//////////////////////////////////////////////////////////////////////////

// Connect to the database
var dbConnect = require(DEFS.DIR.DB_CONNECT)('openshift');
var sp        = require(DEFS.DIR.DB_SP);

var userFavorites = function() {
  
  // format for call back: callback(returnMsg, returnData);
  // Fetch the user details from DB using the provided user ID
  this.getCategoryFavoritesByUserId = function(userFavoritesArr, callback) {

    var returnData = {};
    var returnMsg;

    //Get the USP 
    var getCategoryFav = new sp('usp_user_category_preferences');
    getCategoryFav.add(userFavoritesArr.user_id, false);
    getCategoryFav.addNull(1); // Category list for get request is null
    getCategoryFav.add(DEFS.CONST.SP_OPCODE['get'], false);

    dbConnect.query(getCategoryFav.call(), function(err, rows) {
      if(err || !rows) {
        SCUBE_LOG.info('DB Error : ' + err + 'while fetching User' 
                + 'catergory favorites for user_id' + uuserFavoritesArr.user_id);
        returnMsg = 'failure'
        callback(returnMsg, null);
        return;
      }
      
      // For Output format refer : 
      //https://sparkking.wikispaces.com/API+-+User+Favorites#QUERY_CASE_BY_USER_ID
      // Build jsonData for user profile 
      var jsonReqArray = {};
      jsonReqArray.reqtype = DEFS.CONST.JSON_TYPE['singleArrayMultipleObj'];
      jsonReqArray.reqData = rows;
      jsonReqArray.arrayName = 'user'; 
 
      jBuilder.buildDBDataJSON(jsonReqArray, function(jsonData) {
          // Send back the restructured data
        SCUBE_LOG.info('usp : usp_user_category_preferences success');
        SCUBE_LOG.info(jsonData);
        returnMsg = 'success';
        callback(returnMsg, jsonData);
        return;
      });
    });
  }

  this.getAllCategories = function(callback) {

    var returnData = {};
    var returnMsg;

    //Get the USP 
    var getCategoriesAll = new sp('usp_get_all_shopping_category');

    dbConnect.query(getCategoriesAll.call(), function(err, rows) {
      if(err || !rows) {
        SCUBE_LOG.info('DB Error : ' + err + 'while fetching all' 
                + 'catergories ');
        returnMsg = 'failure'
        callback(returnMsg, null);
        return;
      }
      
      // For Output format refer : 
      // https://sparkking.wikispaces.com/API+-+User+Favorites#QUERY_CASE_GET_ALL
      // Build jsonData for user profile 
      var jsonReqArray = {};
      jsonReqArray.reqtype = DEFS.CONST.JSON_TYPE['singleArrayMultipleObj'];
      jsonReqArray.reqData = rows;
      jsonReqArray.arrayName = 'catergories'; 
 
      jBuilder.buildDBDataJSON(jsonReqArray, function(jsonData) {
          // Send back the restructured data
        SCUBE_LOG.info('usp : usp_get_all_shopping_category success');
        SCUBE_LOG.info(jsonData);
        returnMsg = 'success';
        callback(returnMsg, jsonData);
        return;
      });
    });
  }
  
  // Plan not to use this for first release 
  this.getBrandsFavorites = function(user_id, callback) {

    var returnData = {};
    var returnMsg;

    //Get the USP 
    var getUserBrandFav = new sp('usp_user_brand_preferences');
    getUserBrandFav.add(user_id, false);
    getUserBrandFav.addNull(1); // Category list for get request is null
    getUserBrandFav.add(DEFS.CONST.SP_OPCODE['get'], false);

    dbConnect.query(getUserBrandFav.call(), function(err, rows) {
      if(err || !rows) {
        SCUBE_LOG.info('DB Error : ' + err + 'while fetching User' 
                + ' brand favorites for userId' + user_id);
        returnMsg = 'failure'
        callback(returnMsg, null);
        return;
      }
      
      // For Output format refer : 
      // https://sparkking.wikispaces.com/API+-+User+Profile#ACTION_TYPE_GET

      // Build jsonData for user profile 
      var jsonReqArray = {};
      jsonReqArray.reqtype = DEFS.CONST.JSON_TYPE['singleArrayMutipleObj'];
      jsonReqArray.reqData = rows;
      jsonReqArray.arrayName = 'user'; 
 
      jBuilder.buildDBDataJSON(jsonReqArray, function(jsonData) {
          // Send back the restructured data
        SCUBE_LOG.info('usp : usp_user_brand_preferences success');
        SCUBE_LOG.info(jsonData);
        returnMsg = 'success';
        callback(returnMsg, jsonData);
        return;
      });
    });
  }
}
module.exports = userFavorites;
